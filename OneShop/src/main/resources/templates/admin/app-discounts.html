<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout/app}">
<head>
<meta charset="UTF-8">
<title>Quản lý Chiết khấu App</title>
<th:block layout:fragment="css">
    <style>
        .table th, .table td { vertical-align: middle; }
        .action-btns a, .action-btns button { margin: 0 3px; }
        .modal-title { font-weight: 600; }
    </style>
</th:block>
</head>

<body>
	<div layout:fragment="content">
		<div class="d-sm-flex align-items-center justify-content-between mb-4 mt-4">
			 <h1 class="h3 mb-0">Quản lý Chiết khấu App</h1>
		</div>
        <p class="lead mb-4">Thiết lập tỉ lệ chiết khấu hoa hồng cho từng gian hàng.</p>

        <div th:if="${message}"
             th:classappend="${'alert-' + (#strings.toLowerCase(status ?: 'info'))}"
             class="alert alert-dismissible fade show" role="alert">
            <span th:text="${message}" class="fs-5"></span> <button type="button" class="btn-close" data-bs-dismiss="alert"
                aria-label="Close"></button>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                 <h6 class="m-0 font-weight-bold">Danh sách Shop đã duyệt</h6>
            </div>
             <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered align-middle">
                        <thead class="table-light text-center">
                            <tr>
                                <th scope="col" style="width: 50px;">STT</th>
                                <th scope="col" class="text-start">Tên cửa hàng</th> <th scope="col">Tỉ lệ chiết khấu</th>
                                <th scope="col">Cập nhật lần cuối</th>
                                <th scope="col" class="text-center" style="width: 120px;">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="shop, shopStat : ${shops}">
                                <td th:text="${shopStat.index + 1}" class="text-center"></td>
                                <td th:text="${shop.name}" class="shop-name-col text-start"></td> <td th:data-commission-rate="${shop.commissionRate}"
                                    th:text="${#numbers.formatDecimal(shop.commissionRate * 100, 1, 1)} + '%'" class="shop-commission-col text-center"></td>
                                <td th:text="${shop.commissionUpdatedAt != null ? #temporals.format(shop.commissionUpdatedAt, 'dd/MM/yyyy HH:mm') : 'N/A'}" class="text-center"></td> <td class="text-center action-btns">
                                    <button type="button" class="btn btn-sm btn-info text-white btn-edit" title="Chỉnh sửa chiết khấu" data-bs-toggle="modal"
                                        data-bs-target="#editCommissionModal"
                                        th:data-shop-id="${shop.id}" th:data-shop-name="${shop.name}"
                                        th:data-commission-rate="${shop.commissionRate * 100}">
                                        <i class="fas fa-pencil-alt"></i> </button>
                                </td>
                            </tr>
                             <tr th:if="${#lists.isEmpty(shops)}">
                                <td colspan="5" class="text-center text-muted py-4">Không có Shop nào đã được duyệt.</td>
                             </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
	</div>

	<div class="modal fade" id="editCommissionModal" tabindex="-1"
		aria-labelledby="editCommissionModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="editCommissionModalLabel">Chỉnh sửa Chiết khấu App</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<form th:action="@{/admin/app-discounts/update}" method="post"
					id="commissionForm">
					<div class="modal-body">
						<input type="hidden" name="shopId" id="modalShopId">
						<div class="mb-3">
							<label for="modalShopName" class="form-label">Tên cửa hàng</label>
                            <input type="text" class="form-control" id="modalShopName" readonly>
						</div>
						<div class="mb-3">
							<label for="newCommissionRate" class="form-label">Chiết khấu App mới (%) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="newCommissionRate" name="newCommissionRatePercent" required min="0" max="100" step="0.1"> <div class="form-text">Nhập giá trị chiết khấu từ 0 đến 100 (Ví dụ: 5.5 cho 5.5%)</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
						<button type="submit" class="btn btn-primary">Lưu thay đổi</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<th:block layout:fragment="js">
        <script>
            $(document).ready(function() {
                // Script cho modal (không đổi)
                $('#editCommissionModal').on('show.bs.modal', function(event) {
                    var button = $(event.relatedTarget);
                    var shopId = button.data('shop-id');
                    var shopName = button.data('shop-name');
                    // Lấy commission rate và làm tròn nếu cần (ví dụ: 2 chữ số thập phân)
                    var commissionRate = parseFloat(button.data('commission-rate')).toFixed(1);
                    var modal = $(this);
                    modal.find('#modalShopId').val(shopId);
                    modal.find('#modalShopName').val(shopName);
                    modal.find('#newCommissionRate').val(commissionRate);
                });

                 // Tự đóng alert sau 5 giây
                var alert = $('.alert');
                if (alert.length) {
                    setTimeout(function() {
                        alert.alert('close');
                    }, 5000);
                }
            });
        </script>
	</th:block>

</body>
</html>