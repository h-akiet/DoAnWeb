<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/guest}">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Cửa hàng</title>

    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/assets/css/common.css}">
        
        <style>
            :root {
                --primary-color: #E85A70;
                --secondary-color: #f07b8d;
                --text-color-dark: #333;
                --text-color-light: #666;
                --border-color: #e0e0e0;
                --background-light: #f8f9fa;
                --background-white: #ffffff;
            }

            .main {
                background-color: var(--background-light);
                padding-top: 20px;
                padding-bottom: 40px;
            }

            .store-locator-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 15px;
            }

            .store-locator-grid {
                grid-template-columns: 400px 1fr;
                gap: 20px;
                display: grid; 
            }

            .filter-area {
                background-color: var(--background-white);
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                margin-bottom: 20px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .filter-area select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 14px;
                background-color: var(--background-white);
                color: var(--text-color-light);
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 16px 12px;
            }

            .filter-area select:disabled {
                background-color: #e9ecef;
                opacity: 0.7;
                cursor: not-allowed;
            }

            .store-list-area {
                background-color: var(--primary-color);
                color: var(--background-white);
                padding: 15px 20px;
                border-radius: 8px 8px 0 0;
                font-size: 16px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .store-list-area i { font-size: 18px; }

            .store-scroll-list {
                background-color: var(--background-white);
                border: 1px solid var(--border-color);
                border-top: none;
                border-radius: 0 0 8px 8px;
                max-height: 500px;
                overflow-y: auto;
                padding: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }

            .store-scroll-list::-webkit-scrollbar { width: 6px; }
            .store-scroll-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
            .store-scroll-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
            .store-scroll-list::-webkit-scrollbar-thumb:hover { background: #aaa; }

            .store-item {
                border: 1px solid var(--border-color);
                border-radius: 6px;
                margin-bottom: 10px;
                overflow: hidden;
                transition: box-shadow 0.2s ease, transform 0.2s ease;
            }

            .store-item:hover {
                box-shadow: 0 3px 8px rgba(0,0,0,0.1);
                transform: translateY(-2px);
            }

            .store-item-header {
                background-color: var(--background-light);
                padding: 12px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
            }

            .store-item-header strong {
                font-size: 15px;
                color: var(--text-color-dark);
                flex-grow: 1;
                margin-right: 10px;
            }

            .store-item-header i {
                color: var(--text-color-light);
                transition: transform 0.3s ease;
            }

            .store-item-body {
                padding: 15px;
                font-size: 14px;
                color: var(--text-color-light);
                display: none;
                border-top: 1px solid var(--border-color);
            }

            .store-item-body p {
                margin-bottom: 10px;
                line-height: 1.5;
                display: flex;
                align-items: flex-start;
            }

            .store-item-body i {
                width: 16px;
                margin-right: 8px;
                color: var(--primary-color);
                flex-shrink: 0;
            }

            .store-item.active .store-item-header i {
                transform: rotate(180deg);
            }

            .store-item.active .store-item-body {
                display: block;
            }

            /* Nút trò chuyện */
            .chat-btn {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background-color: var(--primary-color);
                color: white;
                padding: 10px 18px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                text-decoration: none;
                transition: all 0.2s ease;
                margin-top: 12px;
                box-shadow: 0 4px 10px rgba(232, 90, 112, 0.4);
            }

            .chat-btn:hover {
                background-color: #d6485e;
                transform: scale(1.02);
                box-shadow: 0 6px 15px rgba(232, 90, 112, 0.6);
            }
            
            /* LÀM NỔI BẬT ICON CHAT BÊN TRONG */
            .chat-btn i {
                font-size: 16px; /* Kích thước icon lớn hơn một chút */
                /* Thêm hiệu ứng pulse cho icon */
                animation: icon-pulse 1.5s infinite; 
                /* Đổ bóng nhẹ cho icon để nổi bật */
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.7); 
                color: white; /* Đảm bảo màu trắng */
            }

            @keyframes icon-pulse {
                0% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.1); opacity: 0.8; }
                100% { transform: scale(1); opacity: 1; }
            }

            .map-area {
                background-color: var(--background-white);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                height: 600px;
                position: sticky;
                top: 20px;
            }

            .map-area iframe {
                width: 100%;
                height: 100%;
                border: none;
            }

            @media (max-width: 992px) {
                .store-locator-grid {
                    grid-template-columns: 1fr;
                }
                .map-area {
                    grid-row: 1;
                    height: 400px;
                    position: static;
                    margin-bottom: 20px;
                }
                .store-list-container {
                     grid-row: 2;
                }
                .store-scroll-list {
                    max-height: none;
                    overflow-y: visible;
                }
            }

            @media (max-width: 576px) {
                .filter-area {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </th:block>
</head>

<body>
<div class="main" layout:fragment="content">
    <div class="store-locator-container">
        <div class="main__breadcrumb" style="margin-bottom: 20px;">
            <div class="breadcrumb__item"><a th:href="@{/}" class="breadcrumb__link">Trang chủ</a></div>
            <div class="breadcrumb__item"><a th:href="@{/contact}" class="breadcrumb__link">Hệ thống cửa hàng</a></div>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>

        <div class="filter-area">
            <select id="provinceSelect">
                <option value="0">Đang tải tỉnh/thành...</option>
            </select>
            <select id="districtSelect" disabled>
                <option value="0">Chọn quận/huyện</option>
            </select>
        </div>

        <div class="store-locator-grid">
            
            <div class="store-list-container">
                <div class="store-list-area">
                    <i class="fas fa-map-marker-alt"></i>
                    <span th:text="${#lists.size(shops)} + ' cửa hàng OneShop trên toàn quốc'">... cửa hàng</span>
                </div>
                <div class="store-scroll-list" th:classappend="${#lists.isEmpty(shops)} ? 'd-flex justify-content-center align-items-center' : ''">
                    <div th:if="${#lists.isEmpty(shops)}" class="text-center text-muted p-5">
                        <p>Hiện chưa có cửa hàng nào.</p>
                    </div>

                    <div class="store-item" th:each="shop, iterStat : ${shops}" th:unless="${#lists.isEmpty(shops)}">
                        <div class="store-item-header" th:attr="onclick='toggleStoreItem(this)'">
                            <strong th:text="'CN ' + ${iterStat.count} + ': ' + ${shop.name}">Store Name</strong>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <div class="store-item-body">
                            <p th:if="${shop.user?.address != null and !#strings.isEmpty(shop.user.address)}">
                                <i class="fas fa-map-marker-alt"></i>
                                <span th:text="${shop.user.address}">Store Address</span>
                            </p>
                            <p th:unless="${shop.user?.address != null and !#strings.isEmpty(shop.user.address)}">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>(Chưa cập nhật địa chỉ)</span>
                            </p>

                            <p th:if="${shop.contactPhone != null and !#strings.isEmpty(shop.contactPhone)}">
                                <i class="fas fa-phone-alt"></i>
                                <span th:text="${shop.contactPhone}">Store Phone</span>
                            </p>
                            <p th:unless="${shop.contactPhone != null and !#strings.isEmpty(shop.contactPhone)}">
                                <i class="fas fa-phone-alt"></i>
                                <span>(Chưa cập nhật SĐT)</span>
                            </p>

                            <div th:if="${shop.user?.id != null}">
							    <a th:href="@{/chat/{id}(id=${shop.user.id})}"
							       class="chat-btn"
							       sec:authorize="isAuthenticated()"
							       onclick="event.stopPropagation();">
							        <i class="fas fa-comment-dots"></i>
							        Trò chuyện ngay
							    </a>
                                <a href="#" class="chat-btn"
                                   sec:authorize="!isAuthenticated()"
                                   onclick="event.stopPropagation(); alert('Vui lòng đăng nhập để trò chuyện!'); return false;">
                                    <i class="fas fa-comment-dots"></i>
                                    Trò chuyện ngay
                                </a>
							</div>

                            <div th:unless="${shop.user?.id != null}" class="text-muted small">
                                <em>(Chưa liên kết chủ shop)</em>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="map-area">
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3918.4843336040823!2d106.76933067469711!3d10.850720457814913!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752763f23816ab%3A0x282f711441b6916f!2zVHLGsOG7nW5nIMSQ4bqhaSBo4buNYyBTxrAgcGjhuqFtIEvhu7kgdGh14bqtdCBUcC4gSOG7kyBDaMOtIE1pbmg!5e0!3m2!1svi!2s!4v1715077051991!5m2!1svi!2s"
                        allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="js">
    <script>
        // Giữ lại hàm này
        function toggleStoreItem(headerElement) {
            const storeItem = headerElement.closest('.store-item');
            if (storeItem) {
                document.querySelectorAll('.store-item.active').forEach(item => {
                    if (item !== storeItem) item.classList.remove('active');
                });
                storeItem.classList.toggle('active');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const provinceSelect = document.getElementById('provinceSelect');
            const districtSelect = document.getElementById('districtSelect');
            
            // API công cộng (miễn phí)
            const provinceApiUrl = 'https://provinces.open-api.vn/api/p/';
            const districtApiUrlBase = 'https://provinces.open-api.vn/api/p/';

            // 1. Tải danh sách tỉnh/thành phố
            fetch(provinceApiUrl)
                .then(response => response.json())
                .then(provinces => {
                    provinceSelect.innerHTML = '<option value="0">Chọn tỉnh/thành phố</option>'; // Reset
                    provinces.forEach(province => {
                        const option = document.createElement('option');
                        // Lưu mã tỉnh vào value để gọi API quận/huyện
                        option.value = province.code; 
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });
                    provinceSelect.disabled = false; // Mở khóa select tỉnh
                })
                .catch(error => {
                    console.error("Lỗi khi tải danh sách tỉnh/thành:", error);
                    provinceSelect.innerHTML = '<option value="0">Lỗi tải dữ liệu</option>';
                });

            // 2. Xử lý khi chọn tỉnh/thành
            provinceSelect.addEventListener('change', function() {
                const selectedProvinceCode = this.value;
                const selectedProvinceName = this.options[this.selectedIndex].text;
                
                // Reset quận/huyện
                districtSelect.innerHTML = '<option value="0">Chọn quận/huyện</option>';
                districtSelect.disabled = true;

                if (selectedProvinceCode !== "0") {
                    // Tải danh sách quận/huyện
                    districtSelect.disabled = true; // Khóa trong khi tải
                    districtSelect.innerHTML = '<option value="0">Đang tải...</option>';
                    
                    fetch(`${districtApiUrlBase}${selectedProvinceCode}/?depth=2`)
                        .then(response => response.json())
                        .then(data => {
                            districtSelect.innerHTML = '<option value="0">Chọn quận/huyện</option>';
                            if (data.districts) {
                                data.districts.forEach(district => {
                                    const opt = document.createElement('option');
                                    // Lưu mã quận/huyện vào value
                                    opt.value = district.code; 
                                    opt.textContent = district.name;
                                    districtSelect.appendChild(opt);
                                });
                                districtSelect.disabled = false; // Mở khóa
                            }
                        })
                        .catch(error => {
                            console.error("Lỗi khi tải danh sách quận/huyện:", error);
                            districtSelect.innerHTML = '<option value="0">Lỗi tải dữ liệu</option>';
                        });
                }
                
                // Gọi hàm lọc (sử dụng TÊN tỉnh)
                filterStores(selectedProvinceName, "0");
            });

            // 3. Xử lý khi chọn quận/huyện
            districtSelect.addEventListener('change', function() {
                const selectedProvinceName = provinceSelect.options[provinceSelect.selectedIndex].text;
                const selectedDistrictName = this.options[this.selectedIndex].text;
                
                // Gọi hàm lọc (sử dụng TÊN)
                filterStores(selectedProvinceName, selectedDistrictName);
            });

            // 4. Hàm lọc cửa hàng (Giữ nguyên logic lọc bằng TÊN)
            function filterStores(provinceName, districtName) {
                const items = document.querySelectorAll('.store-item');
                let visible = 0;
                let noResult = document.querySelector('#no-result-message');
                if (!noResult) {
                    noResult = document.createElement('div');
                    noResult.id = 'no-result-message';
                    noResult.className = 'text-center text-muted p-5';
                    noResult.style.display = 'none';
                    const scrollList = document.querySelector('.store-scroll-list');
                    if(scrollList) {
                         scrollList.appendChild(noResult);
                    }
                }

                items.forEach(item => {
                    const addrSpan = item.querySelector('.store-item-body span[th\\:text*="shop.user.address"]');
                    const addr = addrSpan ? addrSpan.textContent.toLowerCase() : '';
                    const name = item.querySelector('.store-item-header strong').textContent.toLowerCase();

                    // Chuẩn hóa tên tỉnh (ví dụ: "Tỉnh Thừa Thiên Huế" -> "thừa thiên huế")
                    let pLower = provinceName.toLowerCase().replace("tỉnh ", "").replace("thành phố ", "");
                    let dLower = districtName.toLowerCase().replace("quận ", "").replace("huyện ", "").replace("thị xã ", "");

                    let pMatch = (provinceName === "0") || addr.includes(pLower) || name.includes(pLower);
                    let dMatch = (districtName === "0");

                    if (pMatch && districtName !== "0") {
                        // Cung cấp các biến thể (ví dụ: "q.1", "quận 1")
                        const alts = [dLower, "q." + dLower, "h." + dLower];
                        dMatch = alts.some(a => addr.includes(a) || name.includes(a));
                    }

                    if (pMatch && dMatch) {
                        item.style.display = 'block';
                        visible++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                const countSpan = document.querySelector('.store-list-area span');
                if (countSpan) {
                    countSpan.textContent = visible + ' cửa hàng phù hợp';
                }

                noResult.style.display = visible === 0 ? 'block' : 'none';
                if (visible === 0) {
                    noResult.textContent = 'Không tìm thấy cửa hàng nào phù hợp với bộ lọc.';
                }
            }
        });
    </script>
    </th:block>
</body>
</html>