<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/guest}">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống Cửa hàng</title>

    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/assets/css/common.css}">
        
        <style>
            :root {
                --primary-color: #E85A70;
                --secondary-color: #f07b8d;
                --text-color-dark: #333;
                --text-color-light: #666;
                --border-color: #e0e0e0;
                --background-light: #f8f9fa;
                --background-white: #ffffff;
            }

            .main {
                background-color: var(--background-light);
                padding-top: 20px;
                padding-bottom: 40px;
            }

            .store-locator-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 15px;
            }

            .store-locator-grid {
                display: grid;
                grid-template-columns: 400px 1fr;
                gap: 20px;
            }

            .filter-area {
                background-color: var(--background-white);
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                margin-bottom: 20px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .filter-area select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 14px;
                background-color: var(--background-white);
                color: var(--text-color-light);
                appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='none' stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 0.75rem center;
                background-size: 16px 12px;
            }

            .filter-area select:disabled {
                background-color: #e9ecef;
                opacity: 0.7;
                cursor: not-allowed;
            }

            .store-list-area {
                background-color: var(--primary-color);
                color: var(--background-white);
                padding: 15px 20px;
                border-radius: 8px 8px 0 0;
                font-size: 16px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .store-list-area i { font-size: 18px; }

            .store-scroll-list {
                background-color: var(--background-white);
                border: 1px solid var(--border-color);
                border-top: none;
                border-radius: 0 0 8px 8px;
                max-height: 500px;
                overflow-y: auto;
                padding: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }

            .store-scroll-list::-webkit-scrollbar { width: 6px; }
            .store-scroll-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
            .store-scroll-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
            .store-scroll-list::-webkit-scrollbar-thumb:hover { background: #aaa; }

            .store-item {
                border: 1px solid var(--border-color);
                border-radius: 6px;
                margin-bottom: 10px;
                overflow: hidden;
                transition: box-shadow 0.2s ease;
            }

            .store-item:hover {
                box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            }

            .store-item-header {
                background-color: var(--background-light);
                padding: 12px 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
            }

            .store-item-header strong {
                font-size: 15px;
                color: var(--text-color-dark);
                flex-grow: 1;
                margin-right: 10px;
            }

            .store-item-header i {
                color: var(--text-color-light);
                transition: transform 0.3s ease;
            }

            .store-item-body {
                padding: 15px;
                font-size: 14px;
                color: var(--text-color-light);
                display: none;
                border-top: 1px solid var(--border-color);
            }

            .store-item-body p {
                margin-bottom: 10px;
                line-height: 1.5;
                display: flex;
                align-items: flex-start;
            }

            .store-item-body i {
                width: 16px;
                margin-right: 8px;
                color: var(--primary-color);
                flex-shrink: 0;
            }

            .store-item.active .store-item-header i {
                transform: rotate(180deg);
            }

            .store-item.active .store-item-body {
                display: block;
            }

            /* Nút trò chuyện */
            .chat-btn {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background-color: var(--primary-color);
                color: white;
                padding: 8px 14px;
                border-radius: 6px;
                font-size: 13px;
                font-weight: 600;
                text-decoration: none;
                transition: all 0.2s ease;
                margin-top: 8px;
            }

            .chat-btn:hover {
                background-color: #d6485e;
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(232, 90, 112, 0.3);
            }

            .chat-btn i {
                font-size: 14px;
            }

            .map-area {
                background-color: var(--background-white);
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                height: 600px;
                position: sticky;
                top: 20px;
            }

            .map-area iframe {
                width: 100%;
                height: 100%;
                border: none;
            }

            @media (max-width: 992px) {
                .store-locator-grid {
                    grid-template-columns: 1fr;
                }
                .map-area {
                    grid-row: 1;
                    height: 400px;
                    position: static;
                    margin-bottom: 20px;
                }
                .store-scroll-list {
                    max-height: none;
                    overflow-y: visible;
                }
            }

            @media (max-width: 576px) {
                .filter-area {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </th:block>
</head>

<body>
<div class="main" layout:fragment="content">
    <div class="store-locator-container">
        <div class="main__breadcrumb" style="margin-bottom: 20px;">
            <div class="breadcrumb__item"><a th:href="@{/}" class="breadcrumb__link">Trang chủ</a></div>
            <div class="breadcrumb__item"><a th:href="@{/contact}" class="breadcrumb__link">Hệ thống cửa hàng</a></div>
        </div>

        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>

        <div class="filter-area">
            <select id="provinceSelect">
                <option value="0">Chọn tỉnh/thành phố</option>
            </select>
            <select id="districtSelect" disabled>
                <option value="0">Chọn quận/huyện</option>
            </select>
        </div>

        <div class="store-locator-grid">
            <div class="store-list-container">
                <div class="store-list-area">
                    <i class="fas fa-map-marker-alt"></i>
                    <span th:text="${#lists.size(shops)} + ' cửa hàng OneShop trên toàn quốc'">... cửa hàng</span>
                </div>
                <div class="store-scroll-list" th:classappend="${#lists.isEmpty(shops)} ? 'd-flex justify-content-center align-items-center' : ''">
                    <div th:if="${#lists.isEmpty(shops)}" class="text-center text-muted p-5">
                        <p>Hiện chưa có cửa hàng nào.</p>
                    </div>

                    <!-- Mỗi cửa hàng -->
                    <div class="store-item" th:each="shop, iterStat : ${shops}" th:unless="${#lists.isEmpty(shops)}">
                        <!-- Header: Click để mở/đóng -->
                        <div class="store-item-header" th:attr="onclick='toggleStoreItem(this)'">
                            <strong th:text="'CN ' + ${iterStat.count} + ': ' + ${shop.name}">Store Name</strong>
                            <i class="fas fa-chevron-down"></i>
                        </div>

                        <!-- Body: Thông tin chi tiết -->
                        <div class="store-item-body">
                            <!-- Địa chỉ -->
                            <p th:if="${shop.user?.address != null and !#strings.isEmpty(shop.user.address)}">
                                <i class="fas fa-map-marker-alt"></i>
                                <span th:text="${shop.user.address}">Store Address</span>
                            </p>
                            <p th:unless="${shop.user?.address != null and !#strings.isEmpty(shop.user.address)}">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>(Chưa cập nhật địa chỉ)</span>
                            </p>

                            <!-- SĐT -->
                            <p th:if="${shop.contactPhone != null and !#strings.isEmpty(shop.contactPhone)}">
                                <i class="fas fa-phone-alt"></i>
                                <span th:text="${shop.contactPhone}">Store Phone</span>
                            </p>
                            <p th:unless="${shop.contactPhone != null and !#strings.isEmpty(shop.contactPhone)}">
                                <i class="fas fa-phone-alt"></i>
                                <span>(Chưa cập nhật SĐT)</span>
                            </p>

                            <!-- NÚT TRÒ CHUYỆN – CHỈ HIỆN KHI CÓ VENDOR -->
                            <div th:if="${shop.user?.id != null}" sec:authorize="isAuthenticated()">
							    <a th:href="@{/chat/{id}(id=${shop.user.id})}"
							       class="chat-btn"
							       onclick="event.stopPropagation();">
							        <i class="fas fa-comment-dots"></i>
							        Trò chuyện ngay
							    </a>
							</div>

                                <!-- CHƯA ĐĂNG NHẬP -->
                                <div sec:authorize="!isAuthenticated()">
                                    <a href="#" class="chat-btn"
                                       onclick="event.stopPropagation(); alert('Vui lòng đăng nhập để trò chuyện!'); return false;">
                                        <i class="fas fa-comment-dots"></i>
                                        Trò chuyện ngay
                                    </a>
                                </div>
                            </div>

                            <!-- Không có vendor -->
                            <div th:unless="${shop.user?.id != null}" class="text-muted small">
                                <em>(Chưa liên kết chủ shop)</em>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bản đồ -->
            <div class="map-area">
                <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3918.4843336040823!2d106.76933067469711!3d10.850720457814913!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752763f23816ab%3A0x282f711441b6916f!2zVHLGsOG7nW5nIMSQ4bqhaSBo4buNYyBTxrAgcGjhuqFtIEvhu7kgdGh14bqtdCBUcC4gSOG7kyBDaMOtIE1pbmg!5e0!3m2!1svi!2s!4v1715077051991!5m2!1svi!2s"
                        allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="js">
    <script>
        function toggleStoreItem(headerElement) {
            const storeItem = headerElement.closest('.store-item');
            if (storeItem) {
                document.querySelectorAll('.store-item.active').forEach(item => {
                    if (item !== storeItem) item.classList.remove('active');
                });
                storeItem.classList.toggle('active');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const provinceSelect = document.getElementById('provinceSelect');
            const districtSelect = document.getElementById('districtSelect');

            const locationData = {
                "Hồ Chí Minh": ["Quận 1", "Quận 3", "Quận 4", "Quận 5", "Quận 6", "Quận 7", "Quận 8", "Quận 10", "Quận 11", "Quận 12", "Bình Tân", "Bình Thạnh", "Gò Vấp", "Phú Nhuận", "Tân Bình", "Tân Phú", "Thủ Đức", "Bình Chánh", "Cần Giờ", "Củ Chi", "Hóc Môn", "Nhà Bè"],
                "Hà Nội": ["Ba Đình", "Hoàn Kiếm", "Tây Hồ", "Long Biên", "Cầu Giấy", "Đống Đa", "Hai Bà Trưng", "Hoàng Mai", "Thanh Xuân", "Hà Đông", "Bắc Từ Liêm", "Nam Từ Liêm", "Sơn Tây", "Ba Vì", "Chương Mỹ", "Đan Phượng", "Đông Anh", "Gia Lâm", "Hoài Đức", "Mê Linh", "Mỹ Đức", "Phú Xuyên", "Phúc Thọ", "Quốc Oai", "Sóc Sơn", "Thạch Thất", "Thanh Oai", "Thanh Trì", "Thường Tín", "Ứng Hòa"],
                "Đà Nẵng": ["Hải Châu", "Thanh Khê", "Sơn Trà", "Ngũ Hành Sơn", "Liên Chiểu", "Cẩm Lệ", "Hòa Vang"],
                "Hải Phòng": ["Hồng Bàng", "Ngô Quyền", "Lê Chân", "Hải An", "Kiến An", "Đồ Sơn", "Dương Kinh", "An Dương", "An Lão", "Bạch Long Vĩ", "Cát Hải", "Kiến Thụy", "Thủy Nguyên", "Tiên Lãng", "Vĩnh Bảo"],
                "Cần Thơ": ["Ninh Kiều", "Bình Thủy", "Cái Răng", "Ô Môn", "Thốt Nốt", "Cờ Đỏ", "Phong Điền", "Thới Lai", "Vĩnh Thạnh"],
                "An Giang": ["Long Xuyên", "Châu Đốc", "Tân Châu", "An Phú", "Châu Phú", "Châu Thành", "Chợ Mới", "Phú Tân", "Thoại Sơn", "Tịnh Biên", "Tri Tôn"],
                "Bà Rịa - Vũng Tàu": ["Vũng Tàu", "Bà Rịa", "Phú Mỹ", "Châu Đức", "Côn Đảo", "Đất Đỏ", "Long Điền", "Xuyên Mộc"]
            };

            // Load tỉnh
            for (const province in locationData) {
                const option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            }
            provinceSelect.disabled = false;

            // Khi chọn tỉnh
            provinceSelect.addEventListener('change', function() {
                const selected = this.value;
                districtSelect.innerHTML = '<option value="0">Chọn quận/huyện</option>';
                if (selected !== "0" && locationData[selected]) {
                    locationData[selected].forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        districtSelect.appendChild(opt);
                    });
                    districtSelect.disabled = false;
                } else {
                    districtSelect.disabled = true;
                }
                filterStores(provinceSelect.value, districtSelect.value);
            });

            // Khi chọn quận
            districtSelect.addEventListener('change', function() {
                filterStores(provinceSelect.value, this.value);
            });

            // Lọc cửa hàng
            function filterStores(province, district) {
                const items = document.querySelectorAll('.store-item');
                let visible = 0;
                let noResult = document.querySelector('#no-result-message');
                if (!noResult) {
                    noResult = document.createElement('div');
                    noResult.id = 'no-result-message';
                    noResult.className = 'text-center text-muted p-5';
                    noResult.style.display = 'none';
                    document.querySelector('.store-scroll-list').appendChild(noResult);
                }

                items.forEach(item => {
                    const addrSpan = item.querySelector('.store-item-body span');
                    const addr = addrSpan ? addrSpan.textContent.toLowerCase() : '';
                    const name = item.querySelector('.store-item-header strong').textContent.toLowerCase();

                    let pMatch = province === "0" || addr.includes(province.toLowerCase()) || name.includes(province.toLowerCase());
                    let dMatch = district === "0";

                    if (pMatch && district !== "0") {
                        const dLower = district.toLowerCase();
                        const alts = [dLower, dLower.replace("quận ", "q."), dLower.replace("huyện ", "h.")];
                        dMatch = alts.some(a => addr.includes(a) || name.includes(a));
                    }

                    if (pMatch && dMatch) {
                        item.style.display = 'block';
                        visible++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                const countSpan = document.querySelector('.store-list-area span');
                if (countSpan) {
                    countSpan.textContent = visible + ' cửa hàng phù hợp';
                }

                noResult.style.display = visible === 0 ? 'block' : 'none';
                if (visible === 0) {
                    noResult.textContent = 'Không tìm thấy cửa hàng nào phù hợp với bộ lọc.';
                }
            }
        });
    </script>
</th:block>
</body>
</html>