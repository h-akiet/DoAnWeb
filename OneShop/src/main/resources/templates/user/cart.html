<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/guest}">
<head>
<meta charset="UTF-8">
<title>Giỏ hàng</title>

<th:block layout:fragment="css">
	<link rel="stylesheet" type="text/css"
		th:href="@{/assets/css/cart.css}">
	<link rel="stylesheet" th:href="@{/assets/css/common.css}">
	<style>
.btn[disabled] {
	background-color: #ccc;
	cursor: not-allowed;
	opacity: 0.6;
}
/* Thêm style cho phần voucher */
.voucher-info {
	margin-top: 10px;
	font-size: 14px;
}

.applied-voucher {
	color: green;
	font-weight: bold;
}

.voucher-error {
	color: red;
	margin-top: 5px;
}

.discount-row {
	color: green;
	font-weight: bold;
}

.ms-2 {
	margin-left: 0.5rem !important;
} /* Bootstrap margin helper */
.mt-2 {
	margin-top: 0.5rem !important;
}

.btn-sm {
	padding: 0.25rem 0.5rem;
	font-size: .875rem;
	border-radius: 0.2rem;
} /* Bootstrap small button */
.btn-outline-danger {
	color: #dc3545;
	border-color: #dc3545;
}

.btn-outline-danger:hover {
	color: #fff;
	background-color: #dc3545;
	border-color: #dc3545;
}
</style>
</th:block>
</head>

<body>

	<div class="main" layout:fragment="content">
		<div class="grid wide">
			<h3 class="main__notify" style="display: none;">
				<div class="main__notify-icon">
					<i class="fas fa-check"></i>
				</div>
				<div class="main__notify-text">Giỏ hàng đã được cập nhật.</div>
			</h3>
			<h3 class="main__notify voucher__notify"
				style="display: none; background-color: #d1ecf1; color: #0c5460;">
				<div class="main__notify-icon">
					<i class="fas fa-tags"></i>
				</div>
				<div class="main__notify-text">Voucher message.</div>
			</h3>
			<h3 class="main__notify voucher__error_notify"
				style="display: none; background-color: #f8d7da; color: #721c24;">
				<div class="main__notify-icon">
					<i class="fas fa-exclamation-triangle"></i>
				</div>
				<div class="main__notify-text">Lỗi voucher.</div>
			</h3>

			<div class="row">
				<div class="col l-8 m-12 s-12">
					<div class="main__cart">
						<table class="shop_table">
							<thead>
								<tr>
									<th class="product-select"><input type="checkbox"
										id="checkAll" checked></th>
									<th class="product-name" colspan="2">Sản phẩm</th>
									<th class="product-price">Giá</th>
									<th class="product-quantity">Số lượng</th>
									<th class="product-subtotal">Tổng</th>
									<th class="product-remove">Xóa</th>
								</tr>
							</thead>
							<tbody>
								<tr
									th:if="${cart == null or cart.items == null or cart.items.isEmpty()}">
									<td colspan="7" style="text-align: center; padding: 20px;">
										Giỏ hàng của bạn đang trống.</td>
								</tr>
								<tr class="cart_item"
									th:each="itemEntry : ${cart != null ? cart.items : T(java.util.Collections).emptyMap()}"
									th:with="item = ${itemEntry.value}"
									th:data-product-id="${item.productId}"
									th:data-price="${item.price}">

									<td class="product-select" data-label="Chọn"><input
										type="checkbox" name="selectedItems" class="item-checkbox"
										th:value="${item.productId}" checked></td>
									<td class="product-thumbnail" data-label="Ảnh">
                                        <img th:src="@{${item.imageUrl ?: '/assets/img/product/no-image.jpg'}}" alt="Product Image">
                                        </td>
									<td class="product-name" data-label="Sản phẩm"><a
										th:href="@{'/product/' + ${item.productId}}"
										th:text="${item.name}" class="name"></a></td>
									<td class="product-price" data-label="Giá">
										<div class="main__cart-price"
											th:text="${#numbers.formatDecimal(item.price, 0, 'COMMA', 0, 'POINT')} + ' đ'"></div>
									</td>
									<td class="product-quantity" data-label="Số lượng">
										<div class="buttons_added">
											<input class="minus is-form" type="button" value="-">
											<input aria-label="quantity" class="input-qty" max="99"
												min="1" type="number" th:value="${item.quantity}"> <input
												class="plus is-form" type="button" value="+">
										</div>
									</td>
									<td class="product-subtotal" data-label="Tổng">
										<div class="main__cart-price"
											th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + ' đ'"></div>
									</td>
									<td class="product-remove" data-label="Xóa"><a
										th:href="@{/cart/remove/{id}(id=${item.productId})}"
										class="main__cart-icon remove-item-link" title="Xóa sản phẩm">
											<i class="far fa-times-circle"></i>
									</a></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<div class="col l-4 m-12 s-12">
					<div class="main__pay">
						<div class="main__pay-title">Tổng số lượng</div>
						<div class="pay-info">
							<div class="main__pay-text">Tổng phụ</div>
							<div class="main__pay-price" id="cart-subtotal">0 đ</div>
						</div>
						<div class="pay-info">
							<div class="main__pay-text">Giao hàng</div>
							<div class="main__pay-price" id="cart-shipping-fee">0 đ</div>
						</div>

						<div class="pay-info discount-row" id="discount-row"
							th:style="${cart == null or cart.discountAmount == null or cart.discountAmount.compareTo(T(java.math.BigDecimal).ZERO) <= 0} ? 'display: none;'">
							<div class="main__pay-text">Giảm giá voucher</div>
							<div class="main__pay-price" id="cart-discount">-0 đ</div>
						</div>

						<div class="pay-info">
							<div class="main__pay-text">Tổng thành tiền</div>
							<div class="main__pay-price" id="cart-grandtotal">0 đ</div>
						</div>
						<button type="button" id="checkoutBtn"
							class="btn btn--default orange" disabled>Tiến hành thanh
							toán</button>

						<div class="main__pay-title">Phiếu ưu đãi</div>
						<div id="applied-voucher-info" class="voucher-info"
							th:style="${cart == null or cart.appliedVoucherCode == null} ? 'display: none;'">
							<span class="applied-voucher">Đã áp dụng: <span
								id="applied-voucher-code" th:text="${cart?.appliedVoucherCode}"></span></span>
							
							<button id="removeVoucherBtn"
								class="btn btn-outline-danger ms-2">Bỏ chọn</button>
								
						</div>
						<div id="voucher-selection-area"
							th:style="${cart != null and cart.appliedVoucherCode != null} ? 'display: none;'">
							<select class="form-control" style="margin-top: 15px;"
								id="voucherCodeSelect">
								<option value="">-- Chọn phiếu ưu đãi --</option>
								<option th:each="voucher : ${applicableVouchers}"
									th:value="${voucher.discountCode}"
									th:text="${voucher.campaignName}">Mô tả voucher (VD:
									Giảm 10K)</option>
							</select>
							<button id="applyVoucherBtn" class="btn btn--default mt-2">Áp
								dụng</button>
							<div id="voucher-error-msg" class="voucher-error voucher-info"
								style="display: none;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<th:block layout:fragment="js">
		<script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function() {
                const SHIPPING_FEE = 30000; // Phí ship mặc định
                let currentCartData = /*[[${cart}]]*/ null;
                
                if (!currentCartData) {
                    // Đảm bảo các trường mới tồn tại (Type Code và Value)
                    currentCartData = { 
                        items: {}, 
                        subtotal: 0, 
                        discountAmount: 0, 
                        appliedVoucherCode: null, 
                        appliedVoucherTypeCode: null, // <-- Cần thiết cho logic mới
                        appliedVoucherValue: 0        // <-- Cần thiết cho logic mới
                    };
                }

                function formatCurrency(number) {
                    if (number === null || typeof number === 'undefined') return '0 đ';
                    const numericValue = parseFloat(number);
                    if (isNaN(numericValue)) return '0 đ';
                    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(numericValue).replace('₫', 'đ');
                }


                // === LOGIC TÍNH TOÁN ĐÃ CẬP NHẬT (Sử dụng Type Code và Value) ===
                function updateCartSummary() {
                    // Đảm bảo CartDto có 4 trường voucher
                    const cartData = currentCartData || { items: {}, appliedVoucherTypeCode: null, appliedVoucherValue: 0 };
                    
                    let calculatedSubtotal = 0; // Tổng phụ dựa trên item được chọn
                    let shipping = 0;
                    let selectedCount = 0;
                    let effectiveDiscount = 0; // Giảm giá thực tế

                    // 1. Tính tổng phụ (chỉ các item được check)
                    $('.item-checkbox:checked').each(function() {
                        selectedCount++;
                        const variantId = $(this).val(); 
                        const item = cartData.items ? cartData.items[variantId] : null;
                        if (item) {
                            calculatedSubtotal += parseFloat(item.subtotal || 0);
                        }
                    });

                    // 2. Tính phí ship và giảm giá
                    if (selectedCount > 0) {
                        shipping = SHIPPING_FEE; // Phí ship mặc định
                        
                        const voucherType = cartData.appliedVoucherTypeCode; // Lấy Type Code (ví dụ: PERCENT, FIXED, FREESHIP)
                        const voucherValue = parseFloat(cartData.appliedVoucherValue || 0); // Lấy Value (ví dụ: 10, 50000)
                        
                        // Khởi tạo effectiveDiscount
                        effectiveDiscount = 0; 

                        // Kiểm tra loại voucher đã áp dụng
                        if (voucherType) {
                            if (voucherType === 'PERCENTAGE') { // Giảm theo phần trăm
                                effectiveDiscount = calculatedSubtotal * (voucherValue / 100);
                            } 
                            else if (voucherType === 'FIXED_AMOUNT') { // Giảm số tiền cố định
                                effectiveDiscount = voucherValue; 
                            } 
                            else if (voucherType === 'FREE_SHIPPING') { // Miễn phí vận chuyển
                                shipping = 0; // Ghi đè phí ship về 0
                                effectiveDiscount = 0; // Không có giảm giá bằng tiền
                            }
                        }
                        
                        // Giảm giá không bao giờ vượt quá tổng phụ
                        effectiveDiscount = Math.min(effectiveDiscount, calculatedSubtotal);

                    } else {
                        // Nếu không chọn item nào
                        shipping = 0;
                        effectiveDiscount = 0;
                    }

                    // 3. Tính tổng thành tiền
                    let grandTotal = (calculatedSubtotal - effectiveDiscount) + shipping;
                    grandTotal = Math.max(0, grandTotal); // Đảm bảo tổng tiền không bao giờ âm

                    // 4. Cập nhật UI
                    $('#cart-subtotal').text(formatCurrency(calculatedSubtotal));
                    $('#cart-shipping-fee').text(formatCurrency(shipping)); // Phí ship đã tính (có thể là 0)

                    if (effectiveDiscount > 0) {
                        $('#cart-discount').text('-' + formatCurrency(effectiveDiscount));
                        $('#discount-row').show();
                    } else {
                        $('#discount-row').hide();
                    }
                    
                    $('#cart-grandtotal').text(formatCurrency(Math.round(grandTotal)));
                    $('#checkoutBtn').prop('disabled', selectedCount === 0);
                    updateVoucherUI(cartData.appliedVoucherCode);
                }
                
                // Hàm cập nhật UI voucher (ẩn/hiện)
                function updateVoucherUI(appliedCode) {
                    const hasItemsInCart = currentCartData && Object.keys(currentCartData.items).length > 0;
                    const hasSelectedItems = $('.item-checkbox:checked').length > 0;

                    if (appliedCode && hasSelectedItems) {
                        $('#applied-voucher-code').text(appliedCode);
                        $('#applied-voucher-info').show();
                        $('#voucher-selection-area').hide();
                        $('#voucher-error-msg').hide().text('');
                    } else if (hasItemsInCart && hasSelectedItems) {
                        $('#applied-voucher-info').hide();
                        $('#voucher-selection-area').show();
                        $('#voucherCodeSelect').val('');
                    } else {
                         $('#applied-voucher-info, #voucher-selection-area').hide();
                         $('#voucher-error-msg').hide().text('');
                    }
                }
                // === KẾT THÚC LOGIC TÍNH TOÁN ĐÃ CẬP NHẬT ===


                // Hàm hiển thị thông báo
                function showNotify(selector, message, duration = 2000) {
                    $('.main__notify').stop().fadeOut('fast');
                    const $notify = $(selector);
                    $notify.find('.main__notify-text').text(message);
                    $notify.fadeIn();
                    clearTimeout($notify.data('timeoutId'));
                    const timeoutId = setTimeout(function() { $notify.fadeOut(); }, duration);
                    $notify.data('timeoutId', timeoutId);
                }

                // Hàm AJAX cập nhật số lượng
                function updateCartAjax(variantId, quantity) {
                    $.ajax({
                        type: "POST",
                        url:  '/api/cart/update', 
                        contentType: "application/json",
                        data: JSON.stringify({ variantId: variantId, quantity: quantity }),
                        success: function(updatedCart) {
                            currentCartData = updatedCart;
                            var productRow = $('.cart_item[data-product-id="' + variantId + '"]');
                            var updatedItem = updatedCart.items ? updatedCart.items[variantId] : null;

                            if (updatedItem) {
                                if (parseInt(productRow.find('.input-qty').val()) !== updatedItem.quantity) {
                                    productRow.find('.input-qty').val(updatedItem.quantity);
                                }
                                productRow.find('.product-subtotal .main__cart-price').text(formatCurrency(updatedItem.subtotal));
                            } else {
                                productRow.remove();
                            }

                            if (!updatedItem || (currentCartData && Object.keys(currentCartData.items).length === 0)) {
                                 $('tbody').html('<tr><td colspan="7" style="text-align: center; padding: 20px;">Giỏ hàng của bạn đang trống.</td></tr>');
                            }

                            updateCartSummary();
                           
                             if (typeof window.updateHeaderCart === 'function') {
                                 window.updateHeaderCart(updatedCart);
                             }
                        },
                        error: function(xhr) {
                            console.error("Lỗi cập nhật giỏ hàng: ", xhr);
                            let errorMsg = 'Có lỗi xảy ra, vui lòng thử lại.';
                             if (xhr.status === 401 || xhr.status === 403) {
                                errorMsg = 'Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.';
                                setTimeout(() => { window.location.href = /*[[@{/login}]]*/ '/login'; }, 1500);
                             } else if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg = xhr.responseJSON.message;
                                if (xhr.status === 400) {
                                    showNotify('.main__notify', errorMsg + ' Đang tải lại...', 5000);
                                    setTimeout(() => { location.reload(); }, 1500);
                                    return;
                                }
                             }
                             showNotify('.main__notify', errorMsg, 3000);
                             
                             var productRow = $('.cart_item[data-product-id="' + variantId + '"]');
                             if(currentCartData && currentCartData.items && currentCartData.items[variantId]){
                                productRow.find('.input-qty').val(currentCartData.items[variantId].quantity);
                             } else {
                                 productRow.find('.input-qty').val(1); 
                             }
                        }
                    });
                }

                // --- LOGIC VOUCHER ---
                $('#applyVoucherBtn').on('click', function() {
                    const voucherCode = $('#voucherCodeSelect').val();
                    if (!voucherCode) {
                        $('#voucher-error-msg').text('Vui lòng chọn một voucher.').show();
                        return;
                    }
                    $('#voucher-error-msg').hide().text('');
                    const $button = $(this);
                    $button.prop('disabled', true).text('Đang áp dụng...');

                    $.ajax({
                        type: "POST",
                        url:  '/api/cart/apply-voucher',
                        contentType: "application/json",
                        data: JSON.stringify({ code: voucherCode }),
                        success: function(updatedCart) {
                            currentCartData = updatedCart;
                            // Cảnh báo này sẽ được xử lý khi Server gửi đủ Type Code và Value
                            if (!updatedCart.appliedVoucherTypeCode) {
                                console.warn("Server không trả về 'appliedVoucherTypeCode' hoặc 'appliedVoucherValue'.");
                            }
                            updateCartSummary();
                           
                        },
                        error: function(xhr) {
                            console.error("Lỗi áp dụng voucher: ", xhr);
                            let errorMsg = 'Có lỗi xảy ra khi áp dụng voucher.';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg = xhr.responseJSON.message;
                            }
                            $('#voucher-error-msg').text(errorMsg).show();
                        },
                        complete: function() {
                             $button.prop('disabled', false).text('Áp dụng');
                        }
                    });
                });
                
                $('#removeVoucherBtn').on('click', function() {
                     $.ajax({
                        type: "POST",
                        url:  '/api/cart/remove-voucher',
                        contentType: "application/json",
                        data: JSON.stringify({}),
                        success: function(updatedCart) {
                            currentCartData = updatedCart;
                            updateCartSummary();
                            showNotify('.voucher__notify', 'Đã gỡ bỏ voucher.');
                        },
                        error: function(xhr) {
                            console.error("Lỗi gỡ voucher: ", xhr);
                             let errorMsg = 'Có lỗi xảy ra khi gỡ voucher.';
                             if (xhr.responseJSON && xhr.responseJSON.message) {
                                 errorMsg = xhr.responseJSON.message;
                             }
                             showNotify('.voucher__error_notify', errorMsg, 3000);
                        }
                    });
                });

                // --- Event Handlers (Checkbox, Quantity, Checkout) ---
                $('#checkAll').on('change', function() {
                    const isChecked = $(this).is(':checked');
                    $('.item-checkbox').prop('checked', isChecked);
                    updateCartSummary();
                });

                $('tbody').on('change', '.item-checkbox', function() {
                    if (!$(this).is(':checked')) {
                        $('#checkAll').prop('checked', false);
                    } else {
                        if ($('.item-checkbox:checked').length === $('.item-checkbox').length) {
                            $('#checkAll').prop('checked', true);
                        }
                    }
                    updateCartSummary();
                });

                $('tbody').on('click', '.plus, .minus', function() {
                    var $input = $(this).closest('.buttons_added').find('.input-qty');
                    var currentVal = parseInt($input.val());
                    var minVal = parseInt($input.attr('min')) || 1;
                    var maxVal = parseInt($input.attr('max')) || 99;
                    var newVal = currentVal;

                    if ($(this).hasClass('plus')) {
                        if (currentVal < maxVal) newVal = currentVal + 1;
                    } else {
                        if (currentVal > minVal) newVal = currentVal - 1;
                    }

                    if (newVal !== currentVal) {
                         $input.val(newVal);
                         var variantId = $(this).closest('.cart_item').data('product-id');
                         // Thêm debounce nhỏ để tránh spam API
                         clearTimeout($input.data('timeoutId'));
                         const timeoutId = setTimeout(() => {
                            updateCartAjax(variantId, newVal);
                         }, 300);
                         $input.data('timeoutId', timeoutId);
                    }
                });

                $('tbody').on('blur', '.input-qty', function() {
                    var $input = $(this);
                    // Hủy mọi lệnh ajax đang chờ (từ .plus, .minus)
                    clearTimeout($input.data('timeoutId')); 
                    
                    var currentValInInput = parseInt($input.val());
                    var variantId = $input.closest('.cart_item').data('product-id');

                    let originalQty = 0;
                    if(currentCartData && currentCartData.items && currentCartData.items[variantId]){
                        originalQty = currentCartData.items[variantId].quantity;
                    }

                    var minVal = parseInt($input.attr('min')) || 1;
                    var maxVal = parseInt($input.attr('max')) || 99;
                    var validatedVal = currentValInInput;

                    if (isNaN(validatedVal) || validatedVal < minVal) {
                        validatedVal = minVal;
                    } else if (validatedVal > maxVal) {
                        validatedVal = maxVal;
                    }

                    if (validatedVal !== currentValInInput) {
                        $input.val(validatedVal);
                    }
                    
                    if (validatedVal !== originalQty) {
                        updateCartAjax(variantId, validatedVal);
                    } else if (validatedVal !== currentValInInput) {
                         // Trường hợp gõ 0 -> validate về 1 (và gốc cũng là 1)
                         updateCartSummary();
                    }
                });

                $('#checkoutBtn').on('click', function() {
                    const selectedIds = [];
                    $('.item-checkbox:checked').each(function() { selectedIds.push($(this).val()); });
                    if (selectedIds.length === 0) {
                        alert('Vui lòng chọn ít nhất một sản phẩm để thanh toán.');
                        return;
                    }
                    window.location.href = '/pay?variantIds=' + selectedIds.join(',');
                });

                // --- Initial Calculation ---
                updateCartSummary(); // Tính toán và cập nhật summary khi trang tải xong

            });
             /*]]>*/
        </script>
	</th:block>
</body>
</html>