<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/guest}">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách sản phẩm</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/assets/css/library.css}">
    <link rel="stylesheet" th:href="@{/assets/css/common.css}">

    <th:block layout:fragment="css">
         <link rel="stylesheet" th:href="@{/assets/css/listProduct.css}">
         <style>
            /* --- BIẾN MÀU & CHUNG --- */
            :root {
                --default-cl: #9e5bab;
                --default-cl-darker: #8a4e9a;
                --black-cl-1: #444444;
                --black-cl-2: #222222;
                --white-cl-1: #fff;
                --white-cl-3: #f8f7fd;
                --orange-cl: #d26e4b;
                --green-cl: #28a745; /* Màu xanh lá cho số lượng bán */
                --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
                --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.1);
                --base-transition: all 0.3s ease;
                --base-radius: 6px;
            }
            .main {
                margin-top: 0; /* Bỏ margin-top cũ */
                background: var(--white-cl-3); /* Nền xám nhạt hơn */
                padding: 30px 0; /* Tăng padding */
            }
            .product-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 15px;
            }

            /* --- THANH FILTER BAR (Sắp xếp) --- */
            .filter-bar {
                background: var(--white-cl-1); padding: 15px 25px; border-radius: var(--base-radius); margin-bottom: 25px;
                display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
                box-shadow: var(--shadow-light);
            }
            .breadcrumb-custom { display: flex; align-items: center; gap: 8px; font-size: 1.4rem; flex-wrap: wrap; }
            .breadcrumb-custom a { color: #666; text-decoration: none; transition: color 0.2s ease; }
            .breadcrumb-custom a:hover { color: var(--default-cl); }
            .breadcrumb-custom i { font-size: 1rem; color: #999; }
            .breadcrumb-custom .active { color: var(--black-cl-2); font-weight: 600; }

            .filter-controls { display: flex; gap: 10px; align-items: center; }
            .filter-btn {
                padding: 8px 16px; border: 1px solid #ddd; background: var(--white-cl-1); border-radius: 4px; font-size: 1.4rem; cursor: pointer;
                transition: var(--base-transition); text-decoration: none; color: #555; font-weight: 500;
            }
            .filter-btn:hover { border-color: var(--default-cl); color: var(--default-cl); background-color: #fcf8fd; }
            .filter-btn.active { background: var(--default-cl); color: var(--white-cl-1); border-color: var(--default-cl); }

            /* --- BỐ CỤC CHÍNH (Sidebar + Grid) --- */
            .content-layout { display: grid; grid-template-columns: 260px 1fr; gap: 25px; }

            /* --- SIDEBAR FILTER --- */
            .sidebar-filter {
                background: var(--white-cl-1); border-radius: var(--base-radius); padding: 25px; height: fit-content;
                position: sticky; top: calc(var(--hight-header, 130px) + 20px); /* Dính dưới header */
                box-shadow: var(--shadow-light);
            }
            .filter-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0; }
            .filter-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
            .filter-title { font-size: 1.6rem; font-weight: 600; color: var(--black-cl-2); margin-bottom: 15px; }

            .filter-option { display: block; padding: 8px 0; cursor: pointer; } /* Đổi display thành block */
            .filter-option input[type="checkbox"] { margin-right: 10px; cursor: pointer; accent-color: var(--default-cl); } /* Màu tím khi check */
            .filter-option label { font-size: 1.4rem; color: #666; cursor: pointer; transition: color 0.2s ease; }
            .filter-option:hover label { color: var(--default-cl); }

            .price-range { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
            .price-input {
                width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1.3rem;
                transition: var(--base-transition);
            }
            .price-input:focus { border-color: var(--default-cl); box-shadow: 0 0 0 3px rgba(158, 91, 171, 0.1); outline: none; }
            .price-range span { color: #999; }

            .apply-filter-btn {
                width: 100%; padding: 10px; background: var(--default-cl); color: var(--white-cl-1); border: none;
                border-radius: 4px; font-size: 1.4rem; cursor: pointer; margin-top: 20px; font-weight: 600;
                text-transform: uppercase; transition: var(--base-transition);
            }
            .apply-filter-btn:hover { background-color: var(--default-cl-darker); transform: translateY(-1px); }

            .clear-filter-btn {
                display: block; text-align: center; margin-top: 12px; color: #888; text-decoration: none; font-size: 1.3rem;
                transition: var(--base-transition);
            }
            .clear-filter-btn:hover { color: var(--default-cl); text-decoration: underline; }
            .clear-filter-btn i { margin-right: 5px; }

            /* --- KHUNG KẾT QUẢ --- */
             #product-list-container { transition: opacity 0.3s ease; }
             #product-list-container.loading { opacity: 0.5; pointer-events: none; }

            .result-info {
                background: var(--white-cl-1); padding: 15px 25px; border-radius: var(--base-radius); margin-bottom: 20px;
                display: flex; justify-content: space-between; align-items: center;
                box-shadow: var(--shadow-light); font-size: 1.5rem; color: #555;
            }
            .result-count { font-weight: 600; color: var(--default-cl); }

            /* --- PRODUCT GRID & CARD --- */
            .product-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; } /* Tăng gap */
            .product-card {
                background: var(--white-cl-1); border-radius: var(--base-radius); overflow: hidden;
                transition: var(--base-transition); position: relative; display: flex; flex-direction: column;
                box-shadow: var(--shadow-light); border: 1px solid #eee; /* Thêm border nhẹ */
            }
            .product-card:hover {
                box-shadow: var(--shadow-medium); transform: translateY(-4px); /* Nhấc lên nhiều hơn */
            }

            .product-image {
                width: 100%; padding-top: 100%; background-size: cover; background-position: center; position: relative;
                overflow: hidden; /* Chứa ảnh khi zoom */
                 background-repeat: no-repeat; /* Thêm no-repeat */
                 transition: transform 0.4s ease; /* Hiệu ứng zoom ảnh */
            }
            .product-card:hover .product-image {
                 transform: scale(1.03); /* Zoom nhẹ ảnh */
            }

            .product-badge { /* Giữ nguyên */ }
            .product-info { padding: 15px; flex: 1; display: flex; flex-direction: column; }
            .product-brand { font-size: 1.2rem; color: #999; text-transform: uppercase; margin-bottom: 4px; }
            .product-name {
                font-size: 1.4rem; line-height: 1.4; color: #333; margin-bottom: 8px; height: 40px; overflow: hidden;
                display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; font-weight: 500;
                transition: color 0.2s ease;
            }
            .product-card:hover .product-name { color: var(--default-cl); } /* Đổi màu tên khi hover */

            .product-rating { /* Giữ nguyên */ }
            .rating-stars { /* Giữ nguyên */ }
            .rating-stars i { font-size: 1.1rem; } /* Chỉnh size */
            .rating-count { font-size: 1.2rem; }

            .product-sold {
                font-size: 1.2rem; color: #666; margin-bottom: 10px;
                display: flex; align-items: center; gap: 5px;
            }
            .product-sold i { font-size: 1.1rem; color: #aaa; }
            /* Style cho số lượng bán > 0 */
            .product-sold.has-sales span { font-weight: 600; color: var(--green-cl); }
            .product-sold.has-sales i { color: var(--green-cl); }


            .product-price { display: flex; align-items: baseline; gap: 8px; margin-top: auto; } /* align baseline */
            .price-current { font-size: 1.6rem; font-weight: 700; color: var(--orange-cl); } /* Đổi màu cam */
            .price-original { font-size: 1.3rem; color: #999; text-decoration: line-through; }

            .product-actions { /* Sống động hơn */
                display: flex; position: absolute; bottom: 0; left: 0; width: 100%; gap: 0; z-index: 3;
                transform: translateY(100%); opacity: 0; transition: all 0.3s ease;
            }
            .product-card:hover .product-actions { transform: translateY(0); opacity: 1; }
            .action-btn {
                flex: 1; padding: 10px; border: none; border-radius: 0; font-size: 1.3rem; cursor: pointer;
                transition: var(--base-transition); background: rgba(158, 91, 171, 0.85); /* Màu tím mờ */
                color: var(--white-cl-1); text-decoration: none; text-align: center; font-weight: 600;
                border-top: 1px solid rgba(255,255,255,0.2);
            }
             .action-btn + .action-btn { /* Thêm đường kẻ giữa 2 nút */
                 border-left: 1px solid rgba(255,255,255,0.2);
             }
            .action-btn:hover { background: var(--default-cl); /* Màu tím đậm hơn */ }


            /* --- PHÂN TRANG --- */
            .pagination-wrapper { display: flex; justify-content: center; margin-top: 35px; padding: 20px 0; }
            .pagination { display: flex; list-style: none; padding: 0; }
            .page-item { margin: 0 4px; }
            .page-link {
                padding: 8px 14px; border: 1px solid #ddd; border-radius: var(--base-radius); cursor: pointer;
                transition: var(--base-transition); background: var(--white-cl-1); color: var(--black-cl-2); font-size: 1.4rem;
                text-decoration: none; display: block; box-shadow: var(--shadow-light);
            }
            .page-item:not(.disabled) .page-link:hover {
                border-color: var(--default-cl); color: var(--default-cl); background-color: #fcf8fd; transform: translateY(-2px);
            }
            .page-item.active .page-link {
                background: var(--default-cl); color: var(--white-cl-1); border-color: var(--default-cl); z-index: 3;
            }
            .page-item.disabled .page-link { color: #ccc; pointer-events: none; border-color: #ddd; background-color: #f9f9f9; }

            /* --- RESPONSIVE --- */
            @media (max-width: 1024px) {
                .content-layout { grid-template-columns: 1fr; }
                .sidebar-filter { display: none; } /* Tạm ẩn sidebar */
                /* Cần nút để bật/tắt sidebar filter trên mobile nếu muốn */
                .product-grid { grid-template-columns: repeat(3, 1fr); }
            }
            @media (max-width: 768px) {
                .product-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; } /* Giảm gap */
                .filter-bar { flex-direction: column; align-items: flex-start; }
                .filter-controls { flex-wrap: wrap; justify-content: flex-start; } /* Cho nút xuống dòng */
                .action-btn { font-size: 1.2rem; padding: 8px;} /* Nút action nhỏ hơn */
            }
            @media (max-width: 480px) {
                 .product-grid { gap: 10px; }
                 .product-info { padding: 10px;}
                 .product-name { font-size: 1.3rem; height: 36px; }
                 .price-current { font-size: 1.5rem;}
                 .price-original { font-size: 1.2rem;}
                 .filter-btn { font-size: 1.3rem; padding: 6px 12px;}
                 .page-link { padding: 6px 10px; font-size: 1.3rem;}
            }

         </style>
    </th:block>
</head>
<body>
    <div class="main" layout:fragment="content">
        <div class="product-container">
            <div class="filter-bar">
                <div class="breadcrumb-custom">
                    <a th:href="@{/}">Trang chủ</a> <i class="fas fa-chevron-right"></i>
                    <span class="active">Tất cả sản phẩm</span>
                </div>
                <div class="filter-controls">
                    <a th:href="@{/products(sort='salesCount,desc', categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                       class="filter-btn"
                       th:classappend="${sort != null and #strings.equals(sort, 'salesCount,desc')} ? 'active' : ''">Bán chạy</a>
                    <a th:href="@{/products(sort='productId,desc', categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                       class="filter-btn"
                       th:classappend="${sort == null or #strings.equals(sort, 'productId,desc')} ? 'active' : ''">Mới nhất</a>
                    <a th:href="@{/products(sort='rating,desc', categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                       class="filter-btn"
                       th:classappend="${sort != null and #strings.equals(sort, 'rating,desc')} ? 'active' : ''">Đánh giá cao</a>
                    <a th:href="@{/products(sort='price,asc', categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                       class="filter-btn"
                       th:classappend="${sort != null and #strings.equals(sort, 'price,asc')} ? 'active' : ''">Giá thấp</a>
                    <a th:href="@{/products(sort='price,desc', categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                       class="filter-btn"
                       th:classappend="${sort != null and #strings.equals(sort, 'price,desc')} ? 'active' : ''">Giá cao</a>
                </div>
            </div>

            <div class="content-layout">
                <aside class="sidebar-filter">
                   <form id="filter-form" th:action="@{/products}" method="GET">
                       <input type="hidden" name="sort" th:value="${sort ?: 'productId,desc'}"> <div class="filter-section">
                           <h3 class="filter-title">Danh mục</h3>
                           <div class="filter-option" th:each="category : ${categories}">
                               <input type="checkbox" name="categories"
                                      th:value="${category.id}"
                                      th:id="'cat-' + ${category.id}"
                                      th:checked="${selectedCategories != null and #lists.contains(selectedCategories, category.id)}">
                               <label th:for="'cat-' + ${category.id}"
                                      th:text="${category.name}">Category Name</label>
                           </div>
                       </div>

                       <div class="filter-section">
                           <h3 class="filter-title">Thương hiệu</h3>
                           <div class="filter-option" th:each="brand : ${brands}">
                               <input type="checkbox" name="brands" th:value="${brand.brandId}"
                                      th:id="'brand-' + ${brand.brandId}"
                                      th:checked="${selectedBrands != null and #lists.contains(selectedBrands, brand.brandId)}">
                               <label th:for="'brand-' + ${brand.brandId}"
                                      th:text="${brand.name}">Brand Name</label>
                           </div>
                       </div>

                       <div class="filter-section">
                           <h3 class="filter-title">Khoảng giá</h3>
                           <div class="price-range">
                               <input type="number" name="minPrice" class="price-input" placeholder="Từ (VNĐ)" th:value="${minPrice}" min="0">
                               <span>-</span>
                               <input type="number" name="maxPrice" class="price-input" placeholder="Đến (VNĐ)" th:value="${maxPrice}" min="0">
                           </div>
                           <button type="submit" class="apply-filter-btn">Áp dụng</button>
                           <a href="#" class="clear-filter-btn"> <i class="fas fa-undo-alt"></i> Xóa bộ lọc </a> </div>
                   </form>
                </aside>

                <main id="product-list-container">
                    <div th:fragment="product_list_fragment">
                        <div class="result-info">
                            <div class="result-text" th:if="${productPage != null}">
                                Hiển thị <span class="result-count" th:text="${productPage.numberOfElements}"></span>
                                trên tổng số <span class="result-count" th:text="${productPage.totalElements}"></span> sản phẩm
                            </div>
                             <div class="result-text" th:unless="${productPage != null and productPage.totalElements > 0}">
                                Không có sản phẩm nào
                             </div>
                        </div>

                        <div class="product-grid" th:if="${productPage != null and !productPage.empty}">
                            <div class="product-card" th:each="product : ${productPage.content}">
                                <a th:href="@{'/product/' + ${product.productId}}" class="product-image-link"> <div class="product-image"
                                         th:style="'background-image: url(\'' + @{${product.primaryImageUrl ?: '/assets/img/product/no-image.jpg'}} + '\');'">
                                         <div class="product-badge"
                                             th:if="${product.originalPrice != null and product.originalPrice > product.price and product.originalPrice > 0}"
                                             th:text="'-' + ${#numbers.formatInteger(100 * (product.originalPrice - product.price) / product.originalPrice, 0)} + '%'">-10%</div>
                                    </div>
                                </a>
                                <div class="product-info">
                                    <div class="product-brand"
                                         th:text="${product.brand != null ? product.brand.name : 'N/A'}">Brand</div>
                                    <a th:href="@{'/product/' + ${product.productId}}" class="product-name-link"> <h3 class="product-name" th:text="${product.name}">Product Name</h3>
                                    </a>

                                    <div class="product-rating">
                                         <th:block th:if="${product.reviewCount != null and product.reviewCount > 0}">
                                            <div class="rating-stars">
                                                <i class="fas fa-star" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${i <= product.rating} ? '' : 'empty'"></i>
                                            </div>
                                            <span class="rating-count" th:text="'(' + ${product.reviewCount} + ')'"></span>
                                        </th:block>
                                         <th:block th:unless="${product.reviewCount != null and product.reviewCount > 0}">
                                            <span class="rating-count">Chưa có đánh giá</span>
                                        </th:block>
                                    </div>

                                     <div class="product-sold" th:classappend="${product.soldCount > 0} ? 'has-sales' : ''">
                                        <i class="fas fa-check-circle"></i>
                                        <span th:text="'Đã bán ' + ${#numbers.formatDecimal(product.soldCount ?: 0, 0, 'POINT', 0, 'COMMA')}"></span>
                                    </div>

                                    <div class="product-price">
                                        <div class="price-current"
                                             th:text="${#numbers.formatDecimal(product.price ?: 0, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</div>
                                        <div class="price-original"
                                             th:if="${product.originalPrice != null and product.originalPrice > product.price}"
                                             th:text="${#numbers.formatDecimal(product.originalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</div>
                                    </div>
                                </div>
                                <div class="product-actions">
                                    <a th:href="@{'/product/' + ${product.productId}}" class="action-btn">Xem</a>
                                    <a th:href="@{'/product/' + ${product.productId}}" class="action-btn">Chọn loại</a>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info text-center mt-3" th:if="${productPage == null or productPage.empty}">
                            <p>Không tìm thấy sản phẩm nào phù hợp.</p>
                        </div>

                         <div class="pagination-wrapper" th:if="${productPage != null and productPage.totalPages > 1}">
                            <nav aria-label="Page navigation">
                                <ul class="pagination">
                                    <li class="page-item" th:classappend="${productPage.first} ? 'disabled' : ''">
                                        <a class="page-link"
                                           th:href="@{/products(page=${currentPage - 1}, size=${productPage.size}, sort=${sort}, categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                                           aria-label="Previous" th:data-page="${currentPage - 1}">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <th:block th:each="i : ${#numbers.sequence(1, totalPages)}">
                                        <li class="page-item" th:classappend="${i == currentPage} ? 'active' : ''">
                                            <a class="page-link"
                                               th:href="@{/products(page=${i}, size=${productPage.size}, sort=${sort}, categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                                               th:text="${i}"
                                               th:data-page="${i}">
                                            </a>
                                        </li>
                                    </th:block>
                                    <li class="page-item" th:classappend="${productPage.last} ? 'disabled' : ''">
                                        <a class="page-link"
                                           th:href="@{/products(page=${currentPage + 1}, size=${productPage.size}, sort=${sort}, categories=${selectedCategories}, brands=${selectedBrands}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                                           aria-label="Next" th:data-page="${currentPage + 1}">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <th:block layout:fragment="js">
        <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
        <script th:src="@{/assets/js/commonscript.js}"></script>
        <script>
            // JavaScript giữ nguyên
            $(document).ready(function() {

                function fetchProducts(url) {
                    $('#product-list-container').addClass('loading');
                    $.ajax({
                        type: 'GET', url: url,
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        success: function(fragment) {
                            $('#product-list-container').html(fragment);
                            // Cuộn lên đầu danh sách sản phẩm sau khi load
                            $('html, body').animate({
                                scrollTop: $("#product-list-container").offset().top - (parseInt(getComputedStyle(document.documentElement).getPropertyValue('--hight-header')) || 130) - 20 // Trừ chiều cao header + khoảng cách
                            }, 300);
                            history.pushState(null, '', url); // Update URL without reloading
                            $('#product-list-container').removeClass('loading');
                        },
                        error: function() {
                            alert('Lỗi khi tải sản phẩm!');
                            $('#product-list-container').removeClass('loading');
                        }
                    });
                }

                function buildUrl() {
                    const params = new URLSearchParams(); // Start fresh
                    const formParams = $('#filter-form').serializeArray();

                    let currentSort = $('input[name="sort"]').val() || 'productId,desc';
                    params.set('sort', currentSort);

                    params.delete('categories');
                    params.delete('brands');

                    formParams.forEach(item => {
                        if (item.value && item.name !== 'sort') {
                             if (item.name === 'categories' || item.name === 'brands') {
                                params.append(item.name, item.value);
                             } else if (item.name === 'minPrice' || item.name === 'maxPrice') {
                                // Chỉ thêm nếu giá trị là số hợp lệ và > 0 (hoặc = 0 cho min)
                                const numValue = parseFloat(item.value);
                                if (!isNaN(numValue) && ((item.name === 'minPrice' && numValue >= 0) || (item.name === 'maxPrice' && numValue > 0)) ) {
                                     params.set(item.name, item.value);
                                }
                             } else {
                                params.set(item.name, item.value);
                             }
                        }
                    });
                    params.set('page', '1');
                    return '/products?' + params.toString();
                }

                function buildUrlWithParam(paramName, paramValue) {
                    const params = new URLSearchParams(window.location.search);
                    params.set(paramName, paramValue);
                    if (paramName !== 'page') {
                        params.set('page', '1');
                    }
                    return '/products?' + params.toString();
                }

                $('#filter-form').on('submit', function(e) {
                    e.preventDefault();
                    const url = buildUrl();
                    fetchProducts(url);
                });

                $('.filter-controls .filter-btn').on('click', function(e) {
                    e.preventDefault();
                    const sortValue = new URL($(this).attr('href'), window.location.origin).searchParams.get('sort');
                    $('input[name="sort"]').val(sortValue);
                    const url = buildUrlWithParam('sort', sortValue); // Dùng buildUrlWithParam để giữ filter
                    fetchProducts(url);
                     $('.filter-controls .filter-btn').removeClass('active');
                     $(this).addClass('active');
                });

                $('#product-list-container').on('click', '.pagination .page-link', function(e) {
                    e.preventDefault();
                    const pageNumber = $(this).data('page');
                    if (pageNumber !== undefined && pageNumber !== null && !$(this).closest('.page-item').hasClass('disabled')) {
                       // Dùng buildUrlWithParam để giữ filter và sort hiện tại
                       const url = buildUrlWithParam('page', pageNumber);
                       fetchProducts(url);
                    }
                });

                $('.clear-filter-btn').on('click', function(e) {
                    e.preventDefault();
                    $('#filter-form').trigger('reset');
                    // Reset sort về mặc định và cập nhật nút active
                    const defaultSort = 'productId,desc';
                    $('input[name="sort"]').val(defaultSort);
                     $('.filter-controls .filter-btn').removeClass('active');
                     $('.filter-controls .filter-btn[href*="sort=' + defaultSort + '"]').addClass('active');
                    // Fetch lại trang đầu tiên không có filter
                    fetchProducts('/products?sort=' + defaultSort + '&page=1');
                });

                window.onpopstate = function(event) {
                    // Load lại content dựa trên URL mới
                    fetchProducts(window.location.pathname + window.location.search);
                     // Update form state based on URL
                     const params = new URLSearchParams(window.location.search);
                     $('#filter-form input[type="checkbox"]').each(function() {
                        $(this).prop('checked', params.getAll($(this).attr('name')).includes($(this).val()));
                     });
                      $('#filter-form input[name="minPrice"]').val(params.get('minPrice') || '');
                      $('#filter-form input[name="maxPrice"]').val(params.get('maxPrice') || '');
                       let currentSort = params.get('sort') || 'productId,desc';
                        $('input[name="sort"]').val(currentSort);
                        $('.filter-controls .filter-btn').removeClass('active');
                        $('.filter-controls .filter-btn[href*="sort=' + currentSort + '"]').addClass('active');
                };

            });
        </script>
    </th:block>
</body>
</html>