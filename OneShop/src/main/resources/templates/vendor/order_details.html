<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{vendor/layout/app}">
<head>
    <title>Chi tiết Đơn hàng</title>
    <style>
        .shipping-update-section {
            border-top: 1px solid #eee;
            margin-top: 1rem;
            padding-top: 1rem;
        }
        #shippingCompanySelect {
            font-size: 0.9rem; /* Giảm cỡ chữ dropdown */
        }
        .loading-spinner {
            display: none; /* Ẩn ban đầu */
            margin-left: 10px;
        }
        /* Style cho thông báo lỗi/thành công nhỏ */
        .shipping-update-feedback {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none; /* Ẩn ban đầu */
        }
        .text-success { color: #198754; }
        .text-danger { color: #dc3545; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
        <h1 class="h3" th:text="'Chi tiết Đơn hàng #' + ${order.id}">Chi tiết Đơn hàng #12348</h1>
        <a th:href="@{/vendor/orders(status=${param.status})}" class="btn btn-secondary"> <i class="fas fa-arrow-left me-2"></i>Quay lại Danh sách
        </a>
    </div>

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>


    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Sản phẩm đã đặt</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <tbody>
                                <tr th:each="item : ${order.orderDetails}">
                                    <td>
                                        <strong th:text="${item.productVariant?.product?.name ?: 'Sản phẩm lỗi'}">Tên sản phẩm</strong>
                                    </td>
                                    <td>
                                         <span th:text="${item.productVariant?.name ?: 'N/A'}"></span>
                                    </td>
                                    <td class="text-center" th:text="${item.quantity}">1</td>
                                     <td class="text-end" th:text="${#numbers.formatCurrency(item.price)}">450.000₫</td>
                                    <td class="text-end fw-bold" th:text="${#numbers.formatCurrency(item.quantity * item.price)}">450.000₫</td>
                                </tr>
                                </tbody>
                        </table>
                    </div>

                    <div class="row justify-content-end text-end mt-4">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Tạm tính (SP):</span>
                                <span th:text="${#numbers.formatCurrency(order.subtotal)}">...</span>
                            </div>

                            <div th:if="${order.discountAmount != null and order.discountAmount.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
                                 class="d-flex justify-content-between text-success">
                                <span class="text-muted">Giảm giá voucher:</span>
                                <span th:text="'-' + ${#numbers.formatCurrency(order.discountAmount)}">...</span>
                            </div>

                             <div class="d-flex justify-content-between">
                                <span class="text-muted">Phí vận chuyển:</span>
                                <span id="displayShippingCost" th:text="${#numbers.formatCurrency(order.shippingCost ?: 0)}">...</span>
                            </div>
                            <div th:if="${order.promotion != null}" class="d-flex justify-content-between mt-2">
                                <small class="text-info">Mã áp dụng:</small>
                                <small class="fw-bold text-info" th:text="${order.promotion.discountCode}"></small>
                            </div>

                            <hr class="mt-2 mb-2">

                             <div class="d-flex justify-content-between h5 fw-bold">
                                <span>Tổng cộng:</span>
                                <span class="text-primary" id="displayGrandTotal" th:text="${#numbers.formatCurrency(order.total)}">825.000₫</span>
                            </div>
                            </div>
                    </div>
                 </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Trạng thái:
                        <span id="currentStatusBadge">
                            <span th:switch="${order.orderStatus?.name()}"
                                  th:with="statusName=${order.orderStatus?.name()}" th:remove="tag">
                                <span th:case="'PENDING'" class="badge bg-secondary">Chờ xác nhận</span>
                                <span th:case="'CONFIRMED'" class="badge bg-primary">Đã xác nhận</span>
                                <span th:case="'DELIVERING'" class="badge bg-warning text-dark">Đang giao</span>
                                <span th:case="'DELIVERED'" class="badge bg-success">Đã giao</span>
                                <span th:case="'CANCELLED'" class="badge bg-danger">Đã hủy</span>
                                <span th:case="'RETURNED'" class="badge bg-dark">Trả hàng</span>
                                <span th:case="*" class="badge bg-light text-dark">Không xác định</span>
                            </span>
                        </span>
                    </h6>
                </div>
                <div class="card-body">
                    <form th:action="@{/vendor/orders/update-status}" method="post">
                         <input type="hidden" name="orderId" th:value="${order.id}" />
                        <label for="orderStatusUpdate" class="form-label">Cập nhật trạng thái</label>
                        <select id="orderStatusUpdate" name="status" class="form-select mb-2"
                                th:disabled="${order.orderStatus?.name() == 'DELIVERING' or order.orderStatus?.name() == 'DELIVERED' or order.orderStatus?.name() == 'CANCELLED' or order.orderStatus?.name() == 'RETURNED'}">
                             <option th:if="${order.orderStatus?.name() == 'PENDING'}" value="CONFIRMED"
                                    th:selected="${order.orderStatus?.name() == 'PENDING'}">Xác nhận đơn hàng</option>
                             <option th:if="${order.orderStatus?.name() == 'PENDING' or order.orderStatus?.name() == 'CONFIRMED'}"
                                     value="CANCELLED">Hủy đơn hàng</option>
                            
                             <option th:if="${order.orderStatus?.name() == 'DELIVERING' or order.orderStatus?.name() == 'DELIVERED' or order.orderStatus?.name() == 'RETURNED'}"
                                     th:value="${order.orderStatus.name()}"
                                     th:text="${order.orderStatus.name()}" disabled selected></option>
                             <option th:if="${order.orderStatus?.name() == 'CONFIRMED' and order.shipper == null}"
                                     th:value="${order.orderStatus.name()}" disabled selected>Đang chờ gán Shipper...</option>
                        </select>
                         <button type="submit" class="btn btn-primary w-100 mt-2"
                                 th:disabled="${order.orderStatus?.name() == 'DELIVERING' or order.orderStatus?.name() == 'DELIVERED' or order.orderStatus?.name() == 'CANCELLED' or order.orderStatus?.name() == 'RETURNED'}">
                                 Cập nhật trạng thái
                         </button>
                    </form>

                     <div class="shipping-update-section">
                         <div id="shipper-assignment-area"
                              th:if="${order.orderStatus?.name() == 'CONFIRMED' and order.shipper == null}">
                             <label for="shipperSelect" class="form-label fw-bold mt-3">Gán Shipper & Bàn giao</label>
                             <div class="input-group">
                                 <select id="shipperSelect" name="shipperId" class="form-select">
                                     <option value="">-- Chọn Shipper --</option>
                                     <option th:each="shipper : ${availableShippers}"
                                             th:value="${shipper.id}"
                                             th:text="${shipper.fullName ?: shipper.username}">Shipper Name</option>
                                 </select>
                                 <button class="btn btn-primary" type="button" id="assignShipperBtn" th:disabled="${order.shippingCompany == null}">Gán & Giao</button>
                             </div>
                             <small class="text-danger" th:if="${order.shippingCompany == null}">Vui lòng chọn ĐVVC trước khi gán Shipper.</small>
                             <div id="shipperAssignFeedback" class="shipping-update-feedback"></div>
                         </div>
                         
                         <div th:if="${order.orderStatus?.name() == 'PENDING' or order.orderStatus?.name() == 'CONFIRMED'}">
                             <label for="shippingCompanySelect" class="form-label fw-bold mt-3">Chọn Đơn vị Vận chuyển</label>
                             <div class="input-group">
                                 <select id="shippingCompanySelect" name="shippingCompanyId" class="form-select">
                                     <option value="">-- Chọn ĐVVC --</option>
                                     <option th:each="company : ${shippingCompanies}"
                                             th:value="${company.shippingId}"
                                             th:text="${company.name}"
                                             th:selected="${order.shippingCompany != null and order.shippingCompany.shippingId == company.shippingId}">
                                         Giao Hàng Nhanh
                                     </option>
                                 </select>
                                 <button class="btn btn-success" type="button" id="updateShippingBtn">Lưu VC</button>
                                 <div class="spinner-border text-primary spinner-border-sm loading-spinner" role="status">
                                     <span class="visually-hidden">Loading...</span>
                                 </div>
                             </div>
                             <div id="shippingUpdateFeedback" class="shipping-update-feedback"></div>
                         </div>
                         
                         <div id="shipper-info-area" th:if="${order.shipper != null}" class="mt-3">
                              <p class="mb-0"><strong class="me-2">Đang giao cho:</strong><span id="displayShipperName" th:text="${order.shipper.fullName ?: order.shipper.username}"></span></p>
                              <p class="mb-0"><strong class="me-2">ĐVVC đã chọn:</strong><span id="displayCompanyName" th:text="${order.shippingCompany?.name ?: 'Chưa chọn'}"></span></p>
                         </div>
                     </div>
                      </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Thông tin Khách hàng</h6>
                </div>
                 <div class="card-body">
                    <p class="mb-1"><strong class="me-2">Tên người nhận:</strong><span th:text="${order.recipientName}"></span></p>
                    <p class="mb-1"><strong class="me-2">Email người đặt:</strong><span th:text="${order.user?.email}"></span></p>
                     <p class="mb-0"><strong class="me-2">Điện thoại giao hàng:</strong><span th:text="${order.shippingPhone}"></span></p>
                </div>
            </div>

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Địa chỉ giao hàng</h6>
                </div>
                 <div class="card-body">
                     <p class="mb-0" th:text="${order.shippingAddress}"></p>
                     <p class="mt-2 mb-0"><strong class="me-2">Thanh toán:</strong><span th:text="${order.paymentMethod}"></span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="js">
    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function() {
            const orderId = /*[[${order.id}]]*/ null;
            let currentStatus = /*[[${order.orderStatus?.name()}]]*/ 'PENDING';
            
            // ... (Các biến DOM) ...
            const $shippingSelect = $('#shippingCompanySelect');
            const $updateShippingBtn = $('#updateShippingBtn');
            const $shippingFeedbackDiv = $('#shippingUpdateFeedback');
            const $loadingSpinner = $('.loading-spinner');
            const $displayShippingCost = $('#displayShippingCost');
            const $displayGrandTotal = $('#displayGrandTotal');
            
            const $shipperSelect = $('#shipperSelect');
            const $assignShipperBtn = $('#assignShipperBtn');
            const $shipperAssignFeedback = $('#shipperAssignFeedback');
            const $shipperAssignmentArea = $('#shipper-assignment-area');
            const $currentStatusBadge = $('#currentStatusBadge'); 
            const $shipperInfoArea = $('#shipper-info-area');
            const $orderStatusUpdate = $('#orderStatusUpdate');
            
            function formatCurrency(number) {
                if (number === null || typeof number === 'undefined') return '0 ₫';
                const numericValue = parseFloat(number);
                if (isNaN(numericValue)) return '0 ₫';
                return numericValue.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
            }

            function showFeedback(message, isSuccess, $targetDiv) {
                $targetDiv.text(message)
                            .removeClass(isSuccess ? 'text-danger' : 'text-success')
                            .addClass(isSuccess ? 'text-success' : 'text-danger')
                            .show();
                 setTimeout(() => { $targetDiv.fadeOut(); }, 4000);
            }
            
            // Hàm cập nhật UI khi chuyển trạng thái thành công
            function updateUIOnSuccess(newStatus, shipperName, newShippingCost, newTotal) {
                 currentStatus = newStatus; // Cập nhật trạng thái hiện tại
                 
                 // 1. Cập nhật Badge Status
                 let badgeHtml = '';
                 if (newStatus === 'DELIVERING') badgeHtml = '<span class="badge bg-warning text-dark">Đang giao</span>';
                 if (newStatus === 'CONFIRMED') badgeHtml = '<span class="badge bg-primary">Đã xác nhận</span>';
                 
                 $currentStatusBadge.html(badgeHtml);
                 
                 // 2. Cập nhật tổng tiền/phí ship
                 $displayShippingCost.text(formatCurrency(newShippingCost));
                 $displayGrandTotal.text(formatCurrency(newTotal));
                 
                 // 3. Vô hiệu hóa/Ẩn/Hiện các khu vực
                 if (newStatus === 'DELIVERING') {
                      $shipperAssignmentArea.hide();
                      $shippingSelect.prop('disabled', true); // Khóa ĐVVC
                      $updateShippingBtn.prop('disabled', true);
                      
                      // Vô hiệu hóa Cập nhật Trạng thái chung
                      $('.card-body form:first button[type="submit"]').prop('disabled', true);
                      $orderStatusUpdate.find('option').prop('disabled', true);
                      
                      // Cập nhật thông tin Shipper
                      $shipperInfoArea.html(`<p class="mb-0"><strong class="me-2">Đang giao cho:</strong><span id="displayShipperName">${shipperName}</span></p>
                                             <p class="mb-0"><strong class="me-2">ĐVVC đã chọn:</strong><span id="displayCompanyName">${$shippingSelect.find('option:selected').text()}</span></p>`).show();
                 }
                 // Cập nhật lại dropdown trạng thái nếu cần
                 if (newStatus === 'CONFIRMED') {
                      $orderStatusUpdate.html('<option value="CANCELLED">Hủy đơn hàng</option>');
                      $orderStatusUpdate.val('CANCELLED');
                      // Bật lại nút Gán Shipper nếu có ĐVVC
                      if ($shippingSelect.val()) {
                          $assignShipperBtn.prop('disabled', false);
                      }
                 }
            }


            // --- XỬ LÝ NÚT GÁN & GIAO ---
            $assignShipperBtn.on('click', function() {
                const selectedShipperId = $shipperSelect.val();
                const selectedCompanyId = $shippingSelect.val();
                
                if (currentStatus !== 'CONFIRMED') {
                     showFeedback('Đơn hàng phải ở trạng thái Đã xác nhận (CONFIRMED) để gán Shipper.', false, $shipperAssignFeedback);
                     return;
                }
                
                if (!selectedCompanyId) { 
                    showFeedback('Vui lòng **chọn Đơn vị Vận chuyển** trước.', false, $shipperAssignFeedback); 
                    return;
                }
                
                if (!selectedShipperId) {
                    showFeedback('Vui lòng **chọn Shipper** để bàn giao.', false, $shipperAssignFeedback);
                    return;
                }
                
                if (!confirm(`Xác nhận gán Shipper và chuyển đơn hàng #${orderId} sang trạng thái Đang giao?`)) {
                    return;
                }

                $assignShipperBtn.prop('disabled', true).text('Đang xử lý...');
                $shipperAssignFeedback.hide();

                $.ajax({
                    type: "POST",
                    url: /*[[@{/vendor/orders/assign-shipper}]]*/ '/vendor/orders/assign-shipper',
                    data: { orderId: orderId, shipperId: selectedShipperId },
                    success: function(response) {
                        if (response.success) {
                            showFeedback(response.message, true, $shipperAssignFeedback);
                            updateUIOnSuccess(response.newStatus, response.shipperName, response.newShippingCost, response.newTotal);
                        } else {
                            showFeedback(response.message || 'Gán Shipper thất bại.', false, $shipperAssignFeedback);
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.message || 'Lỗi hệ thống khi gán Shipper.';
                        showFeedback(errorMsg, false, $shipperAssignFeedback);
                    },
                    complete: function() {
                        $assignShipperBtn.prop('disabled', false).text('Gán & Giao');
                    }
                });
            });

            // --- XỬ LÝ NÚT LƯU ĐVVC ---
            $updateShippingBtn.on('click', function() {
                const selectedCompanyId = $shippingSelect.val();
                if (!selectedCompanyId) { showFeedback('Vui lòng chọn một đơn vị vận chuyển.', false, $shippingFeedbackDiv); return; }
                
                $updateShippingBtn.prop('disabled', true);
                $shippingSelect.prop('disabled', true);
                $loadingSpinner.show();
                $shippingFeedbackDiv.hide();

                $.ajax({
                    type: "POST",
                    url: /*[[@{/vendor/orders/update-shipping}]]*/ '/vendor/orders/update-shipping',
                    data: { orderId: orderId, shippingCompanyId: selectedCompanyId },
                    success: function(response) {
                        if (response.success) {
                            showFeedback(response.message, true, $shippingFeedbackDiv);
                            $displayShippingCost.text(formatCurrency(response.newShippingCost));
                            $displayGrandTotal.text(formatCurrency(response.newTotal));
                            $shippingSelect.val(response.selectedCompanyId);
                            // Bật nút Gán Shipper (nếu đang ở CONFIRMED)
                            if (currentStatus === 'CONFIRMED') {
                                $assignShipperBtn.prop('disabled', false);
                            }
                        } else {
                            showFeedback(response.message || 'Có lỗi xảy ra.', false, $shippingFeedbackDiv);
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.message || 'Lỗi không xác định. Vui lòng thử lại.';
                        showFeedback(errorMsg, false, $shippingFeedbackDiv);
                    },
                    complete: function() {
                        $updateShippingBtn.prop('disabled', false);
                        $shippingSelect.prop('disabled', false);
                        $loadingSpinner.hide();
                    }
                });
            });
            
             // --- LOGIC CHUNG KHI TẢI TRANG ---
             // Vô hiệu hóa nút Gán Shipper nếu chưa có ĐVVC được chọn
            if (!$shippingSelect.val()) {
                $assignShipperBtn.prop('disabled', true);
            }
        });
        /*]]>*/
    </script>
</th:block>
</body>
</html>