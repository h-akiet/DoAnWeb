<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE">OneShop
	Kênh Bán Hàng</title>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" th:href="@{/assets/css/vendor.css}">
<th:block layout:fragment="css"></th:block>
</head>
<body>
	<div class="d-flex" id="wrapper">
		<div id="sidebar-wrapper">
			<div class="sidebar-heading">OneShop Seller</div>
			<div class="list-group list-group-flush">
				<a th:href="@{/vendor/dashboard}"
					class="list-group-item list-group-item-action"
					th:classappend="${currentPage == 'dashboard'} ? 'active' : ''">
					<i class="fas fa-tachometer-alt me-2"></i>Bảng điều khiển
				</a> <a th:href="@{/vendor/shop}"
					class="list-group-item list-group-item-action"
					th:classappend="${currentPage == 'shop'} ? 'active' : ''"> <i
					class="fas fa-store me-2"></i>Quản lý Shop
				</a> <a th:href="@{/vendor/products}"
					class="list-group-item list-group-item-action"
					th:classappend="${currentPage == 'products'} ? 'active' : ''">
					<i class="fas fa-box-open me-2"></i>Quản lý Sản phẩm
				</a> <a th:href="@{/vendor/categories}"
					class="list-group-item list-group-item-action"
					th:classappend="${currentPage == 'categories'} ? 'active' : ''">
					<i class="fas fa-sitemap me-2"></i>Danh mục
				</a> <a th:href="@{/vendor/brands}"
					class="list-group-item list-group-item-action"
					th:classappend="${currentPage == 'brands'} ? 'active' : ''"> <i
					class="fas fa-copyright me-2"></i>Quản lý Thương hiệu
				</a> <a th:href="@{/vendor/orders}"
					class="list-group-item list-group-item-action"
					th:classappend="${currentPage == 'orders'} ? 'active' : ''"> <i
					class="fas fa-receipt me-2"></i>Quản lý Đơn hàng
				</a> <a th:href="@{/vendor/chat}"
					class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
					th:classappend="${currentPage == 'chat'} ? 'active' : ''"> <span>
						<i class="fas fa-comments me-2"></i>Tin nhắn
				</span> <span class="badge bg-danger rounded-pill"
					id="sidebar-unread-count"
					style="display: none; font-size: 0.7em; padding: .3em .5em;">0</span>
				</a> <a th:href="@{/vendor/revenue}"
					class="list-group-item list-group-item-action"
					th:classappend="${currentPage == 'revenue'} ? 'active' : ''"> <i
					class="fas fa-chart-line me-2"></i>Doanh thu
				</a> <a th:href="@{/}"
					class="list-group-item list-group-item-action mt-auto"> <i
					class="fas fa-sign-out-alt me-2"></i>Quay lại trang chủ
				</a>
			</div>
		</div>
		<div id="page-content-wrapper">
			<nav class="navbar navbar-expand-lg navbar-light">
				<div class="container-fluid">
					<button class="btn btn-primary" id="menu-toggle">
						<i class="fas fa-bars"></i>
					</button>

					<button class="navbar-toggler" type="button"
						data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
						aria-controls="navbarSupportedContent" aria-expanded="false"
						aria-label="Toggle navigation">
						<span class="navbar-toggler-icon"></span>
					</button>

					<div class="collapse navbar-collapse" id="navbarSupportedContent">
						<ul class="navbar-nav ms-auto mt-2 mt-lg-0">
							<li class="nav-item dropdown"><a
								class="nav-link dropdown-toggle" href="#" id="navbarDropdown"
								role="button" data-bs-toggle="dropdown" aria-haspopup="true"
								aria-expanded="false"> <i class="fas fa-user me-1"></i> <span
									sec:authentication="name">Tên Vendor</span>
							</a>
								<div class="dropdown-menu dropdown-menu-end"
									aria-labelledby="navbarDropdown">
									<a class="dropdown-item" th:href="@{/vendor/profile}">Hồ sơ</a>
									<div class="dropdown-divider"></div>
									<a class="dropdown-item" href="javascript:void(0);"
										onclick="document.getElementById('logoutForm').submit();">Đăng
										xuất</a>
								</div></li>
						</ul>
					</div>
				</div>
			</nav>

			<main class="container-fluid p-4" layout:fragment="content"></main>
		</div>
	</div>
	<form id="logoutForm" th:action="@{/logout}" method="post"
		style="display: none;"></form>

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script th:src="@{/assets/js/vendor.js}"></script>

	<th:block layout:fragment="js">
		<script th:inline="javascript">
            /*<![CDATA[*/
            (function() {
                // Lấy username của vendor (nếu đã đăng nhập)
                const currentUsername = /*[[${#authentication.name}]]*/ null;
                if (!currentUsername) return; // Nếu không có username (lỗi?) thì dừng

                const UNREAD_STORAGE_KEY = 'vendorUnreadCounts_' + currentUsername;
                const sidebarUnreadBadge = document.getElementById('sidebar-unread-count');

                // Hàm đọc localStorage
                function getUnreadCountsFromStorage() {
                    try {
                        const storedCounts = localStorage.getItem(UNREAD_STORAGE_KEY);
                        return storedCounts ? JSON.parse(storedCounts) : {};
                    } catch (e) { return {}; }
                }

                // Hàm cập nhật sidebar (chỉ đọc và hiển thị)
                function updateSidebarCountOnLoad() {
                    const counts = getUnreadCountsFromStorage();
                    let totalUnread = 0;
                    for (const username in counts) {
                        totalUnread += counts[username] || 0;
                    }

                    if (sidebarUnreadBadge) {
                        if (totalUnread > 0) {
                            sidebarUnreadBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                            sidebarUnreadBadge.style.display = 'inline-block';
                        } else {
                            sidebarUnreadBadge.textContent = '0';
                            sidebarUnreadBadge.style.display = 'none';
                        }
                    }
                }

                // Chạy hàm này ngay khi DOM được tải
                document.addEventListener('DOMContentLoaded', updateSidebarCountOnLoad);

                // Thêm một listener để lắng nghe sự kiện cập nhật từ tab chat
                // (Phòng trường hợp người dùng mở 2 tab, 1 tab chat, 1 tab dashboard)
                window.addEventListener('storage', function(e) {
                    if (e.key === UNREAD_STORAGE_KEY) {
                        // Khi localStorage thay đổi, cập nhật lại sidebar
                        updateSidebarCountOnLoad();
                    }
                });

            })(); // Chạy ngay lập tức
            /*]]>*/
        </script>
	</th:block>
</body>
</html>